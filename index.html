<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPScxLjEnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzEyMCcgaGVpZ2h0PScxMjAnIHhtbG5zOmlua3NjYXBlID0naHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSc+CiAgICAgICAgPGNpcmNsZSBzdHlsZT0nZmlsbDojRjY3ODEyO3N0cm9rZTojRkZGRkZGOyBzdHJva2Utd2lkdGg6MScgY3g9JzEwMCcgY3k9JzEwMCcgcj0nMC41MjA4MzMzaW4nIHRyYW5zZm9ybT0nbWF0cml4KDEuMTkyMDIzLDAsMCwxLjE5MjAyMiwtNTkuNDcwMTMsLTU5LjEzNjgpJyB2ZWN0b3ItZWZmZWN0PSdub24tc2NhbGluZy1zdHJva2UnIHBlbj0nMy41NzYwOTIsMy41NzYwOTInIC8+CiAgICAgICAgPHBhdGggc3R5bGU9J2ZpbGw6I0ZERkNGQztzdHJva2U6bm9uZTsgc3Ryb2tlLXdpZHRoOjEnIGQ9J202Ni4zOSw0OS45MmMxLjYyLC0wLjAyIDM5LjI5LC0wLjM3IDQxLjA2LC0wLjRjMTIuMDcsMC4wMyAyMS4wOSwzLjk3IDI5LjY5LDEyLjM1YzEuMDgsMS4xMSAzLjMzLDMuMzggMy45MiwzLjk2YzExLjM3LDEyLjA0IDEyLjkzLDI2LjkxIDEyLjY0LDQyLjYyYy0wLjMyLDcuMDMgLTIsMTIuNDUgLTUuMzgsMTguNjZjLTAuNjcsMS4zMyAtMC42NywxLjMzIC0xLjM1LDIuNjhjLTYuNSwxMS45MiAtMTYuNTQsMTkuOSAtMjkuNTEsMjMuODljLTIuNTIsMC41IC00Ljg2LDAuNTYgLTcuNDIsMC41N2MtMS4wNiwwLjAxIC00NC4wNywwLjEgLTQ1LjQ5LDAuMWMtMi4yMywtMC4yNSAtMi4yMywtMC4yNSAtNC4yMywtMi4yNWMtMC4yNywtMy4xOSAtMC4yNiwtOS41MiAtMC4yNywtMTAuODFjMC4yNywtMy4xOSAwLjI3LC0zLjE5IDIuMjcsLTUuMTljMi4wNCwtMC4yNSAzNC4xNSwtMC40MiAzNy40NywtMC40NmMxLjAyLDAgMi4wNCwwLjAxIDMuMDksMC4wMWM4LjkyLC0wLjEyIDE2LjIyLC0yLjYzIDIyLjg3LC04LjcyYzcuMTEsLTguMzIgOS4wNCwtMTguNjkgOC44OSwtMjkuMzJjLTAuODcsLTkuNTggLTYuMDEsLTE4LjM0IC0xMy4zMiwtMjQuNTFjLTIuOTMsLTEuNTIgLTMuOTMsLTIuMjcgLTYuNSwtMy42Yy0wLjY2LC0wLjMzIC0zLjgyLC0xLjA2IC00LjUsLTEuNGMtMS41NywtMC4xMSAtNDYuMTQsLTAuODQgLTQ3LjAzLC0wLjg1Yy0xLjk3LC0wLjE1IC0xLjk3LC0wLjE1IC0yLjk3LC0xLjE1Yy0wLjEsLTIuNTEgLTAuMTMsLTguOSAtMC4xNCwtOS42M2MwLjAxLC02LjA5IDAuMjEsLTYuNDggNi4yLC02LjU2bDAsMHonIGlkPSc0MScgdHJhbnNmb3JtPSdtYXRyaXgoMC42MDM5NTA5LDAsMCwwLjYwMzk1MDksLTAuMjQ4Njg1MywtMC4xMTY2ODA4KScgdmVjdG9yLWVmZmVjdD0nbm9uLXNjYWxpbmctc3Ryb2tlJyBwZW49JzAuNjAzOTUxNywwLjYwMzk1MTgnIC8+CiAgICAgICAgPHBhdGggc3R5bGU9J2ZpbGw6I0ZDRkFGQTtzdHJva2U6bm9uZTsgc3Ryb2tlLXdpZHRoOjEnIGQ9J202OS41NCw3MC44OGMwLjczLC0wLjAxIDExLjYsLTAuMTIgMTMuOTUsLTAuMTZjOS44OCwtMC4xIDE2LjgsMS4wMSAyNS4wOCw2LjU5YzcuODUsOC4wMyA5LjA2LDE2LjIzIDkuMDcsMjYuOTVjLTAuMTYsOS4zNyAtMy4xNSwxNC45NSAtOS4xNCwyMi4wM2MtNS44Niw0LjkyIC0xMS40OCw2LjQyIC0xOS4wMSw2LjI1Yy0wLjgxLDAgLTIxLjQyLC0wLjIgLTIyLjYxLC0wLjIxYy01LjQzLC0wLjEgLTUuNDMsLTAuMSAtNi41NSwtMS4yMmMtMC4xMiwtMi4xNCAtMC4yMiwtOC43OSAtMC4yMywtMTBjMC4yMywtMyAtMC42NywtNS4xMSAyLjIzLC01YzIuNDYsLTAuMTggMjYuODUsLTAuMzQgMjcuNTcsLTAuMzNjMy43LC0wLjA4IDUuMTYsLTAuNCA3Ljg0LC0zLjAyYzIuMzgsLTMuOTYgMi43NywtNi45NyAyLjg0LC0xMS41MmMwLjA0LC0xLjU0IC0xLjEyLC04LjM3IC0zLjI1LC0xMS4xMmMtMy41NiwtMi40MSAtNy4yNCwtMi4zNCAtMTEuMzksLTIuNDFjLTAuNzEsLTAuMDIgLTIwLjg4LC0wLjUxIC0yNC42MSwtMC41OWMtMC4wMywtMi40OCAtMC4wNSwtMTMuMTkgMCwtMTVjLTAuMzcsLTEuOTQgNS41NywtMS4yMSA4LjIyLC0xLjI0eicgdHJhbnNmb3JtPSdtYXRyaXgoMC42MDM5NTA5LDAsMCwwLjYwMzk1MDcsLTAuMjQ4Njg1MywtMC4xMTY2ODA4KScgdmVjdG9yLWVmZmVjdD0nbm9uLXNjYWxpbmctc3Ryb2tlJyBwZW49JzAuNjAzOTUyMSwwLjYwMzk1MTknIC8+CiAgICA8L3N2Zz4=">
    <title>DuinoI2C_ESP Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@400;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff6214;
            --accent-color: #FFD93D;
        }

        * {
            box-sizing: border-box;
        }

        .at{
            margin-left: 5px;
            display: flex;
            align-items: center;
        }

        .att{
            color: #000000;
            margin: 0px 2px;
        }

        .att.dark{
            color: #FFFFFF;
        }

        .head a{
            width:40px;
            height:40px;
        }

        .head{
            width: max-content;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            text-align: center;
            gap:5px;
            align-items: center;
        }

        #darkModeToggle {
            margin-left: auto;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: #f0f0f0;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
        }

        #darkModeToggle .icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transition: opacity 0.3s;
        }

        #darkModeToggle .icon::before,
        #darkModeToggle .icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transition: opacity 0.3s;
        }

        #darkModeToggle .icon::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z'/%3E%3C/svg%3E");
            opacity: 1;
        }

        #darkModeToggle .icon::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z'/%3E%3C/svg%3E");
            opacity: 0;
        }

        #darkModeToggle.dark {
            background-color: #1a1a1a;
        }

        #darkModeToggle.dark .icon::before {
            opacity: 0;
        }

        #darkModeToggle.dark .icon::after {
            opacity: 1;
        }

        body {
        transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #161616;
        }
        
        .webserial-container {
            transition: background-color 0.3s, color 0.3s;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 15px;
            background-color: #f5f5f5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .webserial-container.dark{
            background-color: #000000;
        }
        
        .safari-message {
            display: none;
            color: #ff0000;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(255, 0, 0, 0.1);
            margin-top: 10px;
        }

        .safari .safari-message {
            display: block;
        }

        .safari .webserial-switch {
            display: none;
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-container h2 {
            padding-bottom: 0px;
            border: none;
            margin: 0;
            font-size: 1.5rem;
        }

        .webserial-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }

        .webserial-switch input {
            display: none;
        }

        .webserial-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cdcdcd;
            transition: 0.4s;
            border-radius: 25px;
        }

        .webserial-slider:before {
            position: absolute;
            content: "";
            height: 17px;
            width: 17px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .webserial-slider {
            background-color: #ff6214;
        }

        input:checked + .webserial-slider:before {
            transform: translateX(24px);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #efefef;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
        }

        .container {
            transition: background-color 0.3s, color 0.3s;
            width:75%;
            max-width: 1500px;
            margin: 5px auto;
            background-color: #ffffff;
            border-radius: 20px;
            padding: 20px 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .container.dark{
            background-color: #000000;
        }

        header {
            margin-top: 5px;
            position: relative;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .logo {
            width: 40px;
            height: 40px;
        }

        h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            color: var(--primary-color);
            margin: 0;
            text-align: center;
        }

        .info-panel {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, color 0.3s;
            border: 1px solid #ddd;
            background-color:#f5f5f5;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items:center;
            justify-content: space-between;
            color: #000000;
        }

        .info-panel.dark{
            background-color: #000000;
            color: #FFFFFF;
        }

        .info-item {
            align-items:center;
            display: flex;
            flex-direction: column;
            flex: 1 1 10px;
        }

        .info-label {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .info-value {
            font-size: 1.1rem;
        }

        .control-panel {
            display: flex;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .control-group {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, color 0.3s;
            border: 1px solid #ddd;
            width:-webkit-fill-available;
            background-color: #F0F0F0;
            border-radius: 15px;
            padding: 20px;
        }

        .control-group.dark {
            background-color: #000000;
        }

        h2 {
            font-family: 'Fredoka One', cursive;
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 10px;
        }
        
        .control-item {
            margin-bottom: 20px;
        }

        .control-item1 {
            margin-bottom: 40px;
        }

        .control-label {
            display: block;
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: bold;
        }

        .control-label.dark{
            color: #FFFFFF;
        }

        .btn {
            background-color: var(--primary-color);
            color: #FFFFFF;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
        }

        .btn:hover {
            background-color: #ff5500;
        }

        .btn.warning {
            color:black;
            background-color: var(--accent-color);
        }

        .btn.warning:hover {
            background-color: #fcd200;
        }

        .slider-container {
            color:#000000;
            display: flex;
            align-items: center;
        }

        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 15px;
            border-radius: 10px;
            background: #ffffff;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            margin-left: 10px;
            font-size: 1.1rem;
        }

        #terminal {
            display: none;
            background-color: #000000;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            border-radius: 5px;
            margin-top: 20px;
            color: #ffffff;
        }

        #terminal.dark{
            background-color: #333;
            color: #ccc;
        }

        #input_div {
            display: none;
            margin-top: 10px;
        }

        #input_el {
            width: -webkit-fill-available;
            padding: 5px;
            background-color: #000000;
            color: white;
            border: none;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }

        #input_el.dark{
            background-color: #333;
            color: #ccc;
        }

        #input_el:focus {
            outline: none;
        }

        footer {
            color: #000000;
            padding: 10px 10px 0px 10px;
            text-align: center;
        }

        .footer-content{
            color:#000000;
        }

        .footer-content.dark{
            color:#FFFFFF;
        }

        .itachi-link {
            color: #ff0000;
            text-decoration: none;
            font-weight: bold;
            position: relative;
            transition: color 0.3s ease;
        }

        .itachi-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: #ff0000;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .itachi-link:hover {
            color: #ff3333;
        }

        .itachi-link:hover::after {
            transform: scaleX(1);
        }

        @media (max-width: 768px) {
            
            body {
                padding: 10px;
                font-size: 14px;
            }
            
            .head{
                left:40%;
                gap:3px;
            }

            .head a{
                height:30px;
                width:30px;
            }

            #darkModeToggle {
                width:32px;
                height:32px;
                margin-top:2px;
            }

            #darkModeToggle .icon{
                width:18px;
                height:18px;
            }

            .info-label {
                font-size: 1rem;
            }
            
            .control-item1 {
                margin-bottom: 20px;
            }

            .container {
                width:95%;
                padding: 15px 20px;
            }

            header {
               gap: 5px;
               align-items: center;
            }

            .logo {
                height: 30px;
                width: 30px;
                margin-right: 0;
            }

            h1 {
                font-size: 1.6rem;
            }

            .info-panel {
                padding:10px;
                flex-direction: column;
            }

            .control-panel {
                flex-wrap: wrap;
                flex-direction: column;
            }

            .control-group {
                width:auto;
                padding: 15px;
            }

            h2 {
                font-size: 1.3rem;
            }
            
            .header-container h2 {
                font-size: 1.3rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 1rem;
            }

            .control-label {
                font-size: 1rem;
            }

            .slider-container {
                flex-direction: column;
                align-items: stretch;
            }

            .slider-value {
                text-align: center;
                margin-top: 5px;
                margin-left: 0;
                font-size: 1rem;
            }

            #terminal {
                font-size: 10px;
                height: 150px;
            }

            #input-el {
                font-size: 12px;
                padding: 6px 10px;
            }

            #input_div{
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="head">
            <a href="https://github.com/JK-Rolling/DuinoI2C_ESP" target="_blank">
              <svg id="svg" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="120" height="120" viewBox="0, 0, 120,120" class="logo">
                <circle style="fill:#F67812;stroke:#FFFFFF; stroke-width:1" cx = "100" cy = "100" r = "0.5208333in" transform = "matrix(1.192023,0,0,1.192022,-59.47013,-59.1368)" vector-effect="non-scaling-stroke" pen = "3.576092,3.576092" />
                <path style="fill:#FDFCFC;stroke:none; stroke-width:1" d="m66.39,49.92c1.62,-0.02 39.29,-0.37 41.06,-0.4c12.07,0.03 21.09,3.97 29.69,12.35c1.08,1.11 3.33,3.38 3.92,3.96c11.37,12.04 12.93,26.91 12.64,42.62c-0.32,7.03 -2,12.45 -5.38,18.66c-0.67,1.33 -0.67,1.33 -1.35,2.68c-6.5,11.92 -16.54,19.9 -29.51,23.89c-2.52,0.5 -4.86,0.56 -7.42,0.57c-1.06,0.01 -44.07,0.1 -45.49,0.1c-2.23,-0.25 -2.23,-0.25 -4.23,-2.25c-0.27,-3.19 -0.26,-9.52 -0.27,-10.81c0.27,-3.19 0.27,-3.19 2.27,-5.19c2.04,-0.25 34.15,-0.42 37.47,-0.46c1.02,0 2.04,0.01 3.09,0.01c8.92,-0.12 16.22,-2.63 22.87,-8.72c7.11,-8.32 9.04,-18.69 8.89,-29.32c-0.87,-9.58 -6.01,-18.34 -13.32,-24.51c-2.93,-1.52 -3.93,-2.27 -6.5,-3.6c-0.66,-0.33 -3.82,-1.06 -4.5,-1.4c-1.57,-0.11 -46.14,-0.84 -47.03,-0.85c-1.97,-0.15 -1.97,-0.15 -2.97,-1.15c-0.1,-2.51 -0.13,-8.9 -0.14,-9.63c0.01,-6.09 0.21,-6.48 6.2,-6.56l0,0z" id = "41" transform = "matrix(0.6039509,0,0,0.6039509,-0.2486853,-0.1166808)" vector-effect="non-scaling-stroke" pen = "0.6039517,0.6039518" />
                <path style="fill:#FCFAFA;stroke:none; stroke-width:1" d="m69.54,70.88c0.73,-0.01 11.6,-0.12 13.95,-0.16c9.88,-0.1 16.8,1.01 25.08,6.59c7.85,8.03 9.06,16.23 9.07,26.95c-0.16,9.37 -3.15,14.95 -9.14,22.03c-5.86,4.92 -11.48,6.42 -19.01,6.25c-0.81,0 -21.42,-0.2 -22.61,-0.21c-5.43,-0.1 -5.43,-0.1 -6.55,-1.22c-0.12,-2.14 -0.22,-8.79 -0.23,-10c0.23,-3 -0.67,-5.11 2.23,-5c2.46,-0.18 26.85,-0.34 27.57,-0.33c3.7,-0.08 5.16,-0.4 7.84,-3.02c2.38,-3.96 2.77,-6.97 2.84,-11.52c0.04,-1.54 -1.12,-8.37 -3.25,-11.12c-3.56,-2.41 -7.24,-2.34 -11.39,-2.41c-0.71,-0.02 -20.88,-0.51 -24.61,-0.59c-0.03,-2.48 -0.05,-13.19 0,-15c-0.37,-1.94 5.57,-1.21 8.22,-1.24z" transform = "matrix(0.6039509,0,0,0.6039507,-0.2486853,-0.1166808)" vector-effect="non-scaling-stroke" pen = "0.6039521,0.6039519" />
              </svg>
            </a>
            <h1>DuinoI2C ESP Hub</h1>
            </div>
            <button id="darkModeToggle" aria-label="Toggle dark mode">
                <span class="icon"></span>
            </button>
        </header>

        <div class="info-panel">
            <div class="info-item">
                <span class="info-label">IP Address:<span id="ip-address" class="info-value">Loading..</span></span>
            </div>
            <div class="info-item">
                <span class="info-label">Firmware Version:<span id="firmware-version" class="info-value">Loading..</span></span>
                
            </div>
        </div>

        <div class="control-panel">
            <div class="control-group">
                <h2>OLED Controls</h2>
                <div class="control-item1">
                    <button id="oled-toggle" class="btn">OLED Screen:OFF</button>
                </div>
                <div class="control-item">
                    <label for="oled-brightness" class="control-label">OLED Brightness: <span id="oled-brightness-value">127</span></label>
                    <div class="slider-container">
                        <input type="range" id="oled-brightness" class="slider" min="0" max="255" value="127">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h2>LED Controls</h2>
                <div class="control-item1">
                    <button id="led-toggle" class="btn">Onboard LED:OFF</button>
                </div>
                <div class="control-item">
                    <label for="wled-brightness" class="control-label">Worker LED Brightness: <span id="wled-brightness-value">127</span></label>
                    <div class="slider-container">
                        <input type="range" id="wled-brightness" class="slider" min="0" max="255" value="127">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h2>System Controls</h2>
                <div class="control-item">
                    <button id="restart-esp" class="btn warning">Restart ESP</button>
                    <button id="update-esp" class="btn warning">Update ESP</button>
                    <button id="reset-oled" class="btn warning">Reset OLED</button>
                </div>
            </div>
        </div>
        
        <div class="webserial-container">
            <div class="header-container">
                <h2 class="wb">Web Serial</h2>
                <label class="webserial-switch">
                    <input type="checkbox" id="toggle-terminal">
                    <span class="webserial-slider round"></span>
                </label>
            </div>
            <!-- Add the Safari message element -->
            <div id="safari-message" class="safari-message">
                Web Serial requires Chrome, Edge, or Firefox for full functionality
            </div>
            <pre id="terminal"><!-- Terminal content will appear here --></pre>
            <div id="input_div">
                <input type="text" id="input_el" placeholder="Type a command...">
                <div class="at">
                    <p class="att">Autoscroll</p>
                    <label class="webserial-switch">
                        <input type="checkbox" id="toggle-terminal2" checked>
                        <span class="webserial-slider round"></span>
                    </label>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-content">
                <p style="font-size:15px">
                    DuinoI2C_ESP by 
                    <a href="https://github.com/JK-Rolling/DuinoI2C_ESP" target="_blank" rel="noopener noreferrer" class="itachi-link">JK Rolling</a> 
                    and Dashboard by 
                    <a href="https://github.com/ItachiPrime" target="_blank" rel="noopener noreferrer" class="itachi-link">Itachi</a>
                </p>
            </div>
        </footer>
    </div>

    <script>

        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if (isSafari) {
            document.body.classList.add('safari');
        }
        //Dark UI Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const body = document.body;
        const at = document.querySelector('.att');
        const el = document.getElementById('input_el');
        const panel = document.querySelector('.info-panel');
        const terminal = document.getElementById('terminal');
        const container = document.querySelector('.container');
        const web = document.querySelector('.webserial-container');
        const footer = document.querySelector('.footer-content');
        
        function toggleDarkMode() {
        darkModeToggle.classList.toggle('dark');
        body.classList.toggle('dark-mode');

        const controlGroups = document.querySelectorAll('.control-group');
        controlGroups.forEach(group => {
            group.classList.toggle('dark');
        });
        const labelGroups = document.querySelectorAll('.control-label');
        labelGroups.forEach(group => {
            group.classList.toggle('dark');
        });

        web.classList.toggle('dark');
        container.classList.toggle('dark');
        footer.classList.toggle('dark');
        terminal.classList.toggle('dark');
        panel.classList.toggle('dark');
        el.classList.toggle('dark');
        at.classList.toggle('dark');
        }

        darkModeToggle.addEventListener('click', toggleDarkMode);


        // Helper function to create XMLHttpRequest
        function createXmlHttpObject() {
            if (window.XMLHttpRequest) {
                return new XMLHttpRequest();
            }
            return new ActiveXObject('Microsoft.XMLHTTP');
        }

        //Function to load IP address
        function loadIPAddress() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("ip-address").innerHTML = this.responseText;
            }
        };
            xhttp.open("GET", "GET_IP", true);
            xhttp.send();
        }

        //Function to load firmware version
        function loadFirmwareVersion() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("firmware-version").innerHTML = this.responseText;
            }
        };
            xhttp.open("GET", "GET_VER", true);
            xhttp.send();
        }

        window.onload = function() {
            loadFirmwareVersion();
            loadIPAddress()
        };

        // OLED Toggle
        document.getElementById('oled-toggle').addEventListener('click', function() {
            var xhttp = createXmlHttpObject();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var status = this.responseText === '0' ? 'OFF':'ON';
                    document.getElementById('oled-toggle').textContent = 'OLED Screen:' + status;
                }
            };
            xhttp.open('PUT', 'oled_toggle', true);
            xhttp.send();
        });

        // LED Toggle
        document.getElementById('led-toggle').addEventListener('click', function() {
            var xhttp = createXmlHttpObject();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var status = this.responseText === '0' ? 'ON':'OFF';
                    document.getElementById('led-toggle').textContent = 'Onboard LED:' + status;
                }
            };
            xhttp.open('PUT', 'led_toggle', true);
            xhttp.send();
        });

        // OLED Brightness
        document.getElementById('oled-brightness').addEventListener('input', function() {
            var value = this.value;
            document.getElementById('oled-brightness-value').textContent = value;
            clearTimeout(this.timeout);
            this.timeout = setTimeout(function() {
                var xhttp = createXmlHttpObject();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        document.getElementById('oled-brightness-value').textContent = this.responseText;
                    }
                };
                xhttp.open('PUT', 'UPDATE_SLIDER?VALUE=' + value, true);
                xhttp.send();
            }, 100);
        });

        // WLED Brightness
        document.getElementById('wled-brightness').addEventListener('input', function() {
            var value = this.value;
            document.getElementById('wled-brightness-value').textContent = value;
            clearTimeout(this.timeout);
            this.timeout = setTimeout(function() {
                var xhttp = createXmlHttpObject();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        document.getElementById('wled-brightness-value').textContent = this.responseText;
                    }
                };
                xhttp.open('PUT', 'wLED_UPDATE_SLIDER?VALUE=' + value, true);
                xhttp.send();
            }, 100);
        });

        // Restart ESP
        document.getElementById('restart-esp').addEventListener('click', function() {
            var xhttp = createXmlHttpObject();
            xhttp.open('PUT', 'restart', true);
            xhttp.send();
        });
        
        // Reset OLED
        document.getElementById('reset-oled').addEventListener('click', function() {
            var xhttp = createXmlHttpObject();
            xhttp.open('PUT', 'oled_reset', true);
            xhttp.send();
        });

        // Update ESP
        document.getElementById('update-esp').addEventListener('click', function() {
            // Use the existing loadIPAddress() function to get the IP address
            loadIPAddress();

            // Wait for a moment to allow the IP address to populate
            setTimeout(function() {
                const ipAddressElement = document.getElementById("ip-address");
                if (ipAddressElement) {
                    const ipAddress = ipAddressElement.innerText.trim();

                    if (ipAddress) {
                        // Construct the firmware URL
                        const firmwareUrl = `http://${ipAddress}/firmware`;

                        // Open the firmware page in a new tab
                        window.open(firmwareUrl, '_blank');
                        console.log(`Opened firmware page: ${firmwareUrl}`);
                    } else {
                        console.error("Failed to retrieve the IP address.");
                    }
                } else {
                    console.error("IP address element not found.");
                }
            }, 500); // Adjust delay as needed
        });
        
        // Webserial fuctionality
        var lastinput = "";
        var ws = null;
        var es = null;
    
        // Helper functions
        function ge(s) { return document.getElementById(s); }
        function ce(s) { return document.createElement(s); }
        function stb() { window.scrollTo(0, document.body.scrollHeight || document.documentElement.scrollHeight); }
    
        // Function to send a string as binary via WebSocket
        function sendBlob(str) {
            var buf = new Uint8Array(str.length);
            for (var i = 0; i < str.length; ++i) buf[i] = str.charCodeAt(i);
            ws.send(buf);
        }

        // Scrolling Function
        function stb() {
        const terminal = ge("terminal");
        const toggle = ge("toggle-terminal2"); // Get the checkbox element

        // Only auto-scroll if the checkbox is checked
        if (toggle.checked) {
            terminal.scrollTop = terminal.scrollHeight;
        }
        }

        // Function to add messages to the terminal
        function addMessage(m) {
            var msg = ce("div");
            var timestamp = new Date().toLocaleTimeString();
            m = "<" + timestamp + ">   " + m;

            // Optional: If you want to escape HTML (to prevent injection), you can do it like this:
            const escapedMessage = document.createTextNode(m);  // Safely escape HTML

            msg.appendChild(escapedMessage);  // Use text node to avoid injection
            ge("terminal").appendChild(msg);
            stb();  // Scroll to the bottom
        }

    
        // WebSocket connection setup
        function startSocket() {
            ws = new WebSocket('ws://' + document.location.host + '/ws', ['arduino']);
            ws.binaryType = "arraybuffer";
    
            ws.onopen = function (e) {
                addMessage("Connected");
            };
    
            ws.onclose = function (e) {
                addMessage("Disconnected");
                setTimeout(startSocket, 3000);
            };
    
            ws.onerror = function (e) {
                console.log("ws error", e);
                addMessage("Error");
            };
    
            ws.onmessage = function (e) {
                var msg = "";
                if (e.data instanceof ArrayBuffer) {
                    msg += "BIN:";
                    var bytes = new Uint8Array(e.data);
                    for (var i = 0; i < bytes.length; i++) {
                        msg += String.fromCharCode(bytes[i]);
                    }
                } else {
                    msg += e.data;
                }
                addMessage(msg);
            };
    
            // Handling input from the user (terminal input)
            ge("input_el").onkeydown = function (e) {
                stb();
                if (e.keyCode == 13 && ge("input_el").value != "") {
                    ws.send(ge("input_el").value);
                    lastinput = ge("input_el").value;
                    ge("input_el").value = "";
                } else if (e.keyCode == 13 && ge("input_el").value == "") {
                    ge("input_el").value = lastinput;
                }
            };
        }
    
        // End WebSocket connection
        function endSocket() {
            if (ws) {
                ws.onclose = function () {}; // Disable onclose handler first
                ws.close();
            }
        }
    
        // SSE connection setup (for receiving events from server)
        function startEvents() {
            es = new EventSource('/events');
    
            es.onopen = function (e) {
                addMessage("Events Opened");
            };
    
            es.onerror = function (e) {
                if (e.target.readyState != EventSource.OPEN) {
                    addMessage("Events Closed");
                }
            };
    
            es.onmessage = function (e) {
                addMessage("Event: " + e.data);
            };
    
            // Handling a specific 'ota' event (custom server-side event)
            es.addEventListener('ota', function (e) {
                addMessage("Event[ota]: " + e.data);
            }, false);
        }
    
        // End SSE connection
        function endEvents() {
            if (es) {
                es.close();
            }
        }
    
        // Add event listener for toggle switch
        ge("toggle-terminal").addEventListener("change", function () {
            const terminal = ge("terminal");
            const inputDiv = ge("input_div");
    
            if (this.checked) {
                terminal.style.display = "block";
                inputDiv.style.display = "flex";
                inputDiv.style.justifyContent = "space-between";
                terminal.innerHTML="";
                startSocket();   // Start WebSocket connection
                startEvents();   // Start SSE connection
            } else {
                terminal.style.display = "none";
                inputDiv.style.display = "none";
                endSocket();     // End WebSocket connection
                endEvents();     // End SSE connection
            }
         });
    
        // Ensure both WebSocket and SSE connections are closed when the page is unloaded or refreshed
        window.onbeforeunload = function () {
            endSocket();    // Close WebSocket connection
            endEvents();    // Close SSE connection
        };
    </script>
</body>
</html>
